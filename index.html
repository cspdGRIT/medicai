<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MedVoice AI - Professional Medical Voice Documentation</title>
    <meta name="description" content="Professional medical voice documentation system. Zero typing, instant reports, hospital-ready formats.">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Main Container */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 1rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid rgba(34, 197, 94, 0.3);
            border-radius: 25px;
            font-weight: 600;
            color: #22c55e;
            font-size: 0.9rem;
        }

        .status-indicator.recording {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
            animation: pulse 2s infinite;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            height: calc(100vh - 140px);
        }

        /* Control Panel */
        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .app-title {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: #333;
        }

        .app-subtitle {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        /* Microphone Button */
        .mic-container {
            position: relative;
            margin: 2rem 0;
        }

        .mic-button {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 3.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-button:hover {
            transform: scale(1.05);
            box-shadow: 0 20px 50px rgba(102, 126, 234, 0.5);
        }

        .mic-button:active {
            transform: scale(0.95);
        }

        .mic-button.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: recording-pulse 1.5s infinite;
        }

        @keyframes recording-pulse {
            0% { transform: scale(1); box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4); }
            50% { transform: scale(1.08); box-shadow: 0 25px 60px rgba(239, 68, 68, 0.6); }
            100% { transform: scale(1); box-shadow: 0 15px 35px rgba(239, 68, 68, 0.4); }
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .recording-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 30px;
            height: 30px;
            background: #ef4444;
            border-radius: 50%;
            border: 3px solid white;
            animation: pulse 1s infinite;
        }

        .mic-status {
            font-size: 1.2rem;
            font-weight: 600;
            margin-top: 1.5rem;
            color: #666;
            min-height: 1.5rem;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .action-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #666;
            border: 2px solid rgba(0, 0, 0, 0.1);
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* Output Panel */
        .output-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .output-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Patient Info Cards */
        .patient-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .info-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 1rem;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            transition: all 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            font-weight: 600;
            margin-bottom: 0.3rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #333;
            min-height: 1.3rem;
        }

        .info-value.detecting {
            background: linear-gradient(90deg, #667eea, #764ba2);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradient 2s ease infinite;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Live Output */
        .live-output {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        .parameters-section, .document-section {
            flex: 1;
            min-height: 0;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .parameters-list {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        .parameter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .parameter-item.detected {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.05);
            animation: slideInRight 0.5s ease-out;
        }

        @keyframes slideInRight {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .parameter-name {
            font-weight: 600;
            color: #555;
        }

        .parameter-value {
            color: #667eea;
            font-weight: 700;
        }

        .document-preview {
            background: #f8fafc;
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.4;
            color: #555;
            height: 250px;
            overflow-y: auto;
            white-space: pre-wrap;
            transition: all 0.3s ease;
        }

        .document-preview.active {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(248, 250, 252, 0.8);
        }

        .transcript-section {
            margin-top: 1rem;
        }

        .transcript-box {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 1rem;
            min-height: 100px;
            max-height: 150px;
            overflow-y: auto;
        }

        .transcript-text {
            color: #666;
            font-style: italic;
            line-height: 1.5;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .app-container {
                padding: 0.5rem;
            }

            .header {
                padding: 1rem;
                border-radius: 15px;
                margin-bottom: 1rem;
            }

            .logo {
                font-size: 1.5rem;
            }

            .main-content {
                grid-template-columns: 1fr;
                gap: 1rem;
                height: auto;
            }

            .control-panel, .output-panel {
                padding: 1.5rem;
                border-radius: 15px;
            }

            .app-title {
                font-size: 1.5rem;
            }

            .app-subtitle {
                font-size: 1rem;
            }

            .mic-button {
                width: 120px;
                height: 120px;
                font-size: 3rem;
            }

            .patient-info {
                grid-template-columns: 1fr 1fr;
                gap: 0.8rem;
            }

            .quick-actions {
                flex-direction: column;
                align-items: stretch;
            }

            .action-btn {
                justify-content: center;
            }

            .live-output {
                gap: 0.8rem;
            }

            .parameters-list, .document-preview {
                height: 180px;
            }

            .transcript-box {
                max-height: 120px;
            }
        }

        @media (max-width: 480px) {
            .patient-info {
                grid-template-columns: 1fr;
            }

            .output-header {
                flex-direction: column;
                align-items: stretch;
            }

            .quick-actions {
                gap: 0.5rem;
            }

            .action-btn {
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }
        }

        /* Loading States */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Touch Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .mic-button {
                width: 130px;
                height: 130px;
            }
            
            .action-btn {
                min-height: 44px;
                padding: 0.8rem 1.2rem;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                🎤 MedVoice AI Professional
            </div>
            <div class="status-indicator" id="systemStatus">
                <i class="fas fa-check-circle"></i>
                <span>System Ready</span>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Control Panel -->
            <section class="control-panel">
                <h1 class="app-title">Voice Medical Documentation</h1>
                <p class="app-subtitle">
                    Professional radiology reports generated instantly from voice input. 
                    Support for CT Brain, MRI Brain, MRI Spine, CT Abdomen, and Stroke Protocols.
                </p>

                <div class="mic-container">
                    <button class="mic-button" id="micButton" aria-label="Start voice recording">
                        <i class="fas fa-microphone" id="micIcon"></i>
                        <div class="recording-indicator" id="recordingIndicator" style="display: none;"></div>
                    </button>
                </div>

                <div class="mic-status" id="micStatus">
                    Tap microphone to start voice documentation
                </div>

                <div class="quick-actions">
                    <button class="action-btn btn-secondary" id="clearBtn">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                    <button class="action-btn btn-primary" id="downloadBtn" style="display: none;">
                        <i class="fas fa-download"></i>
                        Download Report
                    </button>
                    <button class="action-btn btn-secondary" id="copyBtn" style="display: none;">
                        <i class="fas fa-copy"></i>
                        Copy Text
                    </button>
                </div>
            </section>

            <!-- Output Panel -->
            <section class="output-panel">
                <div class="output-header">
                    <h2 class="output-title">
                        <i class="fas fa-file-medical"></i>
                        Live Documentation
                    </h2>
                </div>

                <!-- Patient Information -->
                <div class="patient-info">
                    <div class="info-card">
                        <div class="info-label">Patient Name</div>
                        <div class="info-value detecting" id="patientName">Listening...</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Exam Type</div>
                        <div class="info-value detecting" id="examType">Detecting...</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Gender</div>
                        <div class="info-value detecting" id="detectedGender">Auto-detect</div>
                    </div>
                    <div class="info-card">
                        <div class="info-label">Age</div>
                        <div class="info-value detecting" id="patientAge">--</div>
                    </div>
                </div>

                <!-- Live Output -->
                <div class="live-output">
                    <div class="parameters-section">
                        <h3 class="section-title">
                            <i class="fas fa-list-check"></i>
                            Extracted Parameters
                        </h3>
                        <div class="parameters-list" id="parametersList">
                            <div class="parameter-item">
                                <span class="parameter-name">🎤 Ready for voice input...</span>
                                <span class="parameter-value">--</span>
                            </div>
                        </div>
                    </div>

                    <div class="document-section">
                        <h3 class="section-title">
                            <i class="fas fa-file-alt"></i>
                            Live Report Preview
                        </h3>
                        <div class="document-preview" id="documentPreview">
Professional medical report will generate automatically as you speak...

Try saying:
• "Patient Rajesh Kumar, 45-year-old male"
• "CT brain shows normal findings"
• "MRI cervical spine for Priya Sharma"
                        </div>
                    </div>
                </div>

                <!-- Transcript -->
                <div class="transcript-section">
                    <h3 class="section-title">
                        <i class="fas fa-quote-left"></i>
                        Live Transcript
                    </h3>
                    <div class="transcript-box">
                        <div class="transcript-text" id="transcriptText">
                            Your voice will be transcribed here in real-time...
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        class MedVoiceAI {
            constructor() {
                this.isRecording = false;
                this.recognition = null;
                this.transcript = '';
                this.patientName = '';
                this.examType = '';
                this.detectedGender = '';
                this.parameters = {};
                this.isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                
                this.initializeApp();
                this.setupEventListeners();
                this.checkBrowserSupport();
            }

            initializeApp() {
                // Initialize speech recognition
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    
                    // Enhanced configuration for mobile
                    this.recognition.continuous = true;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';
                    this.recognition.maxAlternatives = 1;
                    
                    // Mobile optimizations
                    if (this.isMobile) {
                        this.recognition.continuous = false; // Better for mobile
                    }
                    
                    this.recognition.onstart = () => {
                        this.updateSystemStatus('recording', 'Recording Active');
                    };
                    
                    this.recognition.onresult = (event) => {
                        this.handleSpeechResult(event);
                    };
                    
                    this.recognition.onerror = (event) => {
                        this.handleSpeechError(event.error);
                    };
                    
                    this.recognition.onend = () => {
                        if (this.isRecording) {
                            // Auto-restart for continuous listening (desktop only)
                            if (!this.isMobile) {
                                setTimeout(() => {
                                    try {
                                        this.recognition.start();
                                    } catch (e) {
                                        console.log('Recognition restart failed:', e);
                                    }
                                }, 100);
                            } else {
                                // On mobile, require manual restart
                                this.updateMicStatus('Tap microphone to continue...');
                            }
                        }
                    };
                } else {
                    this.showNotification('Speech recognition not supported in this browser. Please use Chrome or Safari.', 'warning');
                }
            }

            setupEventListeners() {
                // Microphone button
                document.getElementById('micButton').addEventListener('click', () => {
                    if (this.isRecording) {
                        this.stopRecording();
                    } else {
                        this.startRecording();
                    }
                });

                // Action buttons
                document.getElementById('clearBtn').addEventListener('click', () => {
                    this.clearAll();
                });

                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadReport();
                });

                document.getElementById('copyBtn').addEventListener('click', () => {
                    this.copyToClipboard();
                });

                // Mobile-specific optimizations
                if (this.isMobile) {
                    // Prevent zoom on double-tap
                    document.addEventListener('touchstart', (e) => {
                        if (e.touches.length > 1) {
                            e.preventDefault();
                        }
                    });

                    // Handle orientation changes
                    window.addEventListener('orientationchange', () => {
                        setTimeout(() => {
                            this.adjustMobileLayout();
                        }, 100);
                    });
                }

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.code === 'Space' && e.ctrlKey) {
                        e.preventDefault();
                        if (this.isRecording) {
                            this.stopRecording();
                        } else {
                            this.startRecording();
                        }
                    }
                });
            }

            checkBrowserSupport() {
                const isSupported = 'webkitSpeechRecognition' in window || 'SpeechRecognition' in window;
                
                if (!isSupported) {
                    this.updateSystemStatus('error', 'Speech Recognition Not Supported');
                    this.updateMicStatus('Please use Chrome, Safari, or Edge browser');
                    document.getElementById('micButton').disabled = true;
                    return false;
                }

                // Check for HTTPS requirement
                if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                    this.showNotification('HTTPS required for microphone access', 'warning');
                }

                this.updateSystemStatus('ready', 'System Ready');
                return true;
            }

            startRecording() {
                if (!this.recognition) {
                    this.simulateDemo();
                    return;
                }

                // Request microphone permission on mobile
                if (this.isMobile && !this.micPermissionGranted) {
                    this.requestMicrophonePermission();
                }

                this.isRecording = true;
                this.updateRecordingUI(true);
                this.updateMicStatus('🎤 Listening... Speak clearly');

                try {
                    this.recognition.start();
                } catch (e) {
                    console.error('Failed to start recognition:', e);
                    this.simulateDemo();
                }
            }

            stopRecording() {
                this.isRecording = false;
                this.updateRecordingUI(false);
                this.updateSystemStatus('ready', 'System Ready');
                this.updateMicStatus('Processing complete - Tap to record again');

                if (this.recognition) {
                    this.recognition.stop();
                }
            }

            requestMicrophonePermission() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(() => {
                            this.micPermissionGranted = true;
                            this.showNotification('Microphone access granted', 'success');
                        })
                        .catch(() => {
                            this.showNotification('Microphone access denied. Please enable in browser settings.', 'error');
                        });
                }
            }

            handleSpeechResult(event) {
                let finalTranscript = '';
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;

                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                        this.transcript += transcript + ' ';
                        this.processTranscript(transcript);
                    } else {
                        interimTranscript += transcript;
                    }
                }

                if (finalTranscript) {
                    this.updateTranscript();
                    this.updateDisplay();
                    this.updateMicStatus('🎤 Processing... Continue speaking');
                }

                // Show interim results for better feedback
                if (interimTranscript) {
                    this.showInterimTranscript(interimTranscript);
                }
            }

            handleSpeechError(error) {
                console.error('Speech recognition error:', error);
                
                const errorMessages = {
                    'network': '🌐 Network error - Check internet connection',
                    'not-allowed': '🎤 Microphone access denied - Check browser permissions',
                    'no-speech': '🔇 No speech detected - Please speak louder',
                    'audio-capture': '🎤 Microphone not working - Check device',
                    'service-not-allowed': '🔒 Speech service not allowed - Try refreshing page',
                    'bad-grammar': '🗣️ Speech not recognized - Try speaking more clearly',
                    'language-not-supported': '🌍 Language not supported - Using English only'
                };

                const message = errorMessages[error] || `🔧 ${error} - Please try again`;
                this.updateMicStatus(message);
                this.showNotification(message, 'error');

                // Auto-retry on certain errors
                if (['network', 'service-not-allowed'].includes(error) && this.isRecording) {
                    setTimeout(() => {
                        if (this.isRecording) {
                            try {
                                this.recognition.start();
                            } catch (e) {
                                this.updateMicStatus('❌ Please refresh page and try again');
                            }
                        }
                    }, 2000);
                }
            }

            processTranscript(text) {
                this.extractPatientName(text);
                this.detectExamType(text);
                this.extractParameters(text);
                this.updateDisplay();
            }

            extractPatientName(text) {
                if (this.patientName) return;

                const namePatterns = [
                    /patient\s+(?:name\s+(?:is\s+)?)?([A-Za-z]+(?:\s+[A-Za-z]+)*)/i,
                    /(?:this\s+is|examining)\s+([A-Za-z]+(?:\s+[A-Za-z]+)*)/i,
                    /([A-Za-z]+(?:\s+[A-Za-z]+)*)\s+(?:is\s+)?(?:the\s+)?patient/i,
                    /(?:mr\.?|ms\.?|mrs\.?|dr\.?)\s+([A-Za-z]+(?:\s+[A-Za-z]+)*)/i,
                    /patient\s+([A-Za-z]+(?:\s+[A-Za-z]+)*)\s+is\s+here/i,
                    /([A-Za-z]+(?:\s+[A-Za-z]+)*)\s+is\s+here\s+for/i,
                    /(?:mri|ct|scan)\s+(?:for\s+)?([A-Za-z]+(?:\s+[A-Za-z]+)*)/i
                ];

                for (let pattern of namePatterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const name = match[1].trim();
                        if (this.isValidName(name)) {
                            this.patientName = name;
                            this.detectedGender = this.guessGenderFromIndianName(name) || 'Unknown';
                            this.showNotification(`Patient detected: ${name}`, 'success');
                            break;
                        }
                    }
                }
            }

            isValidName(name) {
                const exclusions = [
                    'patient', 'exam', 'blood', 'pressure', 'heart', 'rate', 'normal',
                    'examination', 'scan', 'study', 'brain', 'chest', 'abdomen',
                    'year', 'old', 'male', 'female', 'doctor', 'imaging', 'cervical',
                    'spine', 'protocol', 'findings', 'shows', 'appears', 'seen'
                ];
                const nameLower = name.toLowerCase();
                return !exclusions.some(word => nameLower.includes(word)) &&
                       name.length >= 2 &&
                       name.length <= 50 &&
                       /^[A-Za-z\s]+$/.test(name);
            }

            guessGenderFromIndianName(name) {
                if (!name) return null;

                const nameLower = name.toLowerCase();

                const malePatterns = [
                    'raj', 'kumar', 'dev', 'singh', 'sharma', 'anil', 'sunil', 'vinod', 'manoj',
                    'ajay', 'vijay', 'sanjay', 'rakesh', 'mahesh', 'ramesh', 'suresh', 'dinesh',
                    'mukesh', 'rajesh', 'naresh', 'umesh', 'yogesh', 'ganesh', 'hitesh', 'jitesh',
                    'amit', 'sumit', 'rohit', 'mohit', 'lalit', 'ankit', 'puneet', 'ravi', 'kiran',
                    'arun', 'varun', 'tarun', 'arjun', 'manan', 'rohan', 'sohan', 'mohan', 'gopal',
                    'krishna', 'rama', 'shiva', 'vishnu', 'indra', 'surya', 'chandra', 'deepak',
                    'ashok', 'alok', 'abhishek', 'akhil', 'nikhil', 'sachin', 'rahul', 'kapil',
                    'aman', 'naman', 'chaman', 'gagan', 'raman', 'shyam', 'harish', 'manish'
                ];

                const femalePatterns = [
                    'priya', 'rani', 'devi', 'kumari', 'bai', 'mata', 'sita', 'gita', 'rita',
                    'neeta', 'seeta', 'maya', 'asha', 'usha', 'nisha', 'rekha', 'lata', 'shanta',
                    'sunita', 'anita', 'mamta', 'sapna', 'pooja', 'meera', 'seema', 'reema',
                    'kavita', 'sangita', 'geeta', 'sushma', 'pushpa', 'deepa', 'sheela', 'leela',
                    'radha', 'sudha', 'vidya', 'divya', 'shreya', 'preeti', 'kriti', 'aditi',
                    'smiti', 'swati', 'bharti', 'aarti', 'shakti', 'shanti', 'jyoti', 'mohini',
                    'laxmi', 'saraswati', 'parvati', 'durga', 'tara', 'mira', 'indira', 'kamala',
                    'vimala', 'nirmala', 'shobha', 'sneha', 'neha', 'megha', 'renu', 'manu'
                ];

                for (let pattern of malePatterns) {
                    if (nameLower.includes(pattern)) return 'M';
                }

                for (let pattern of femalePatterns) {
                    if (nameLower.includes(pattern)) return 'F';
                }

                if (nameLower.endsWith('a') && !nameLower.endsWith('ma') && !nameLower.endsWith('na')) {
                    return 'F';
                }

                if (nameLower.endsWith('i') || nameLower.endsWith('ya')) {
                    return 'F';
                }

                return null;
            }

            detectExamType(text) {
                if (this.examType) return;

                const examKeywords = {
                    'CT Brain': [
                        'ct brain', 'brain ct', 'ct head', 'head ct', 'computed tomography brain',
                        'cerebral', 'grey matter', 'white matter', 'basal ganglia', 'thalami',
                        'posterior fossa', 'ventricular system', 'hemorrhage', 'midline shift'
                    ],
                    'MRI Brain': [
                        'mri brain', 'brain mri', 'magnetic resonance brain', 'diffusion weighted',
                        'flair', 'dwi', 'angiography', 'intra cranial', 'intracranial',
                        'acute infarct', 'intracerebral hemorrhage'
                    ],
                    'MRI Stroke Protocol': [
                        'stroke protocol', 'mri stroke', 'stroke mri', 'acute stroke',
                        'stroke imaging', 'emergency stroke', 'stroke evaluation'
                    ],
                    'MRI Cervical Spine': [
                        'mri cervical spine', 'cervical spine mri', 'mri spine', 'spine mri',
                        'cervical', 'c spine', 'whole spine screening', 'spinal canal',
                        'vertebral bodies', 'canal diameters', 'curvature', 'alignment'
                    ],
                    'CT Abdomen': [
                        'ct abdomen', 'abdomen ct', 'ct pelvis', 'abdominal ct',
                        'liver', 'gallbladder', 'pancreas', 'spleen', 'kidneys',
                        'abdominal imaging', 'pelvic imaging', 'peritoneal'
                    ]
                };

                let maxScore = 0;
                let detectedExam = '';

                for (let [exam, keywords] of Object.entries(examKeywords)) {
                    const score = keywords.filter(keyword =>
                        text.toLowerCase().includes(keyword.toLowerCase())
                    ).length;

                    if (score > maxScore) {
                        maxScore = score;
                        detectedExam = exam;
                    }
                }

                if (maxScore >= 1) {
                    this.examType = detectedExam;
                    this.showNotification(`Exam type: ${detectedExam}`, 'success');
                }
            }

            extractParameters(text) {
                const paramPatterns = {
                    'Age': [
                        /(?:age\s+(?:is\s+)?|patient\s+is\s+|(?:\d+\s+)?(?:year\s+old\s+)?(?:male|female)\s+)(\d+)\s*(?:years?\s+old)?/i,
                        /(\d+)[\s-]year[\s-]old/i,
                        /(?:this\s+is\s+a\s+)?(\d+)[\s-]year[\s-]old/i,
                        /age\s+(\d+)/i,
                        /(\d+)\s+years?\s+old/i
                    ],
                    'Cerebral Matter': [
                        /cerebral\s+grey\s+and\s+white\s+matter\s+(.+?)(?:\.|basal|findings)/i,
                        /grey\s+matter\s+(.+?)(?:\.|white|basal)/i,
                        /white\s+matter\s+(.+?)(?:\.|basal|posterior)/i,
                        /(appear\s+normal)/i,
                        /(no\s+focal\s+lesion)/i
                    ],
                    'Basal Ganglia': [
                        /basal\s+ganglia\s+(?:and\s+thalami\s+)?(?:are\s+)?(.+?)(?:\.|posterior|cerebellum)/i,
                        /thalami\s+(?:are\s+)?(.+?)(?:\.|posterior)/i
                    ],
                    'Posterior Fossa': [
                        /posterior\s+fossa\s+structures\s+(.+?)(?:\.|ventricular)/i,
                        /cerebellum\s+(?:and\s+brainstem\s+)?(.+?)(?:\.|ventricular)/i,
                        /brainstem\s+(.+?)(?:\.|ventricular)/i
                    ],
                    'Ventricular System': [
                        /ventricular\s+system\s*,?\s*cisternal\s*&?\s*sulcal\s+spaces\s+(?:are\s+)?(.+?)(?:\.|hemorrhage)/i,
                        /ventricles\s+(?:are\s+)?(.+?)(?:\.|cisternal)/i
                    ],
                    'Hemorrhage': [
                        /(no\s+intra\s*\/?\s*extra[\s-]?axial\s+bleed)/i,
                        /(no\s+intracerebral\s+hemorrhage)/i,
                        /hemorrhage\s+(.+?)(?:\.|midline)/i
                    ],
                    'Midline Shift': [
                        /(no\s+midline\s+shift)/i,
                        /(no\s+herniations)/i,
                        /midline\s+shift\s+(.+?)(?:\.|skull)/i
                    ],
                    'Diffusion Weighted': [
                        /(no\s+restriction\s+(?:is\s+)?seen\s+on\s+diffusion\s+weighted\s+images)/i,
                        /diffusion\s+weighted\s+(.+?)(?:\.|acute)/i,
                        /(no\s+acute\s+infarct)/i
                    ],
                    'MR Angiography': [
                        /angiography\s+shows\s*:?\s*(.+?)(?:impression|consultant)/i,
                        /intracranial\s+(?:internal\s+)?carotid\s+arteries\s+(.+?)(?:\.|basilar)/i,
                        /basilar\s+artery\s+(.+?)(?:\.|vertebral)/i,
                        /vertebral\s+arteries\s+(.+?)(?:\.|impression)/i
                    ],
                    'Curvature': [
                        /curvature\s+of\s+spine\s+is\s+(.+?)(?:\.|canal)/i,
                        /curvature\s+(?:is\s+)?(.+?)(?:\.|canal)/i
                    ],
                    'Vertebral Bodies': [
                        /vertebral\s+bodies\s+(?:are\s+)?(.+?)(?:\.|configuration)/i,
                        /alignment\s*,?\s*heights\s+(?:and\s+bone\s+marrow\s+signal\s+intensity\s+)?(.+?)(?:\.|configuration)/i
                    ],
                    'Liver': [
                        /liver\s+is\s+(.+?)(?:\.|cbd|gallbladder)/i,
                        /liver\s+(.+?)(?:\.|normal\s+in)/i
                    ],
                    'Gallbladder': [
                        /gallbladder\s+is\s+(.+?)(?:\.|spleen|wall)/i,
                        /gallbladder\s+(.+?)(?:\.|wall)/i
                    ],
                    'Pancreas': [
                        /pancreas\s*:?\s*(.+?)(?:\.|both\s+kidneys|kidneys)/i,
                        /pancreas\s+(.+?)(?:\.|normal)/i
                    ],
                    'Kidneys': [
                        /(?:both\s+)?kidneys\s+(?:are\s+)?(.+?)(?:\.|adrenal|aorta)/i,
                        /kidneys\s+(.+?)(?:\.|normal)/i
                    ],
                    'Impression': [
                        /impression\s*:?\s*(.+?)(?:consultant|dr\.|radiologist)/i,
                        /conclusion\s*:?\s*(.+?)(?:consultant|dr\.)/i
                    ]
                };

                for (let [paramName, patterns] of Object.entries(paramPatterns)) {
                    if (this.parameters[paramName]) continue;

                    for (let pattern of patterns) {
                        const match = text.match(pattern);
                        if (match) {
                            let value = match[1] || match[0];
                            value = value.trim();
                            if (value.endsWith('.')) {
                                value = value.slice(0, -1);
                            }

                            this.parameters[paramName] = value;
                            break;
                        }
                    }
                }
            }

            updateDisplay() {
                // Update patient information
                document.getElementById('patientName').textContent = this.patientName || 'Listening...';
                document.getElementById('examType').textContent = this.examType || 'Detecting...';
                document.getElementById('detectedGender').textContent = this.detectedGender || 'Auto-detect';
                document.getElementById('patientAge').textContent = this.parameters['Age'] || '--';

                // Remove detecting class when data is found
                if (this.patientName) {
                    document.getElementById('patientName').classList.remove('detecting');
                }
                if (this.examType) {
                    document.getElementById('examType').classList.remove('detecting');
                }
                if (this.detectedGender && this.detectedGender !== 'Unknown') {
                    document.getElementById('detectedGender').classList.remove('detecting');
                }
                if (this.parameters['Age']) {
                    document.getElementById('patientAge').classList.remove('detecting');
                }

                this.updateParametersList();
                this.updateDocumentPreview();
                this.showActionButtons();
            }

            updateParametersList() {
                const paramsList = document.getElementById('parametersList');

                if (Object.keys(this.parameters).length === 0) {
                    paramsList.innerHTML = `
                        <div class="parameter-item">
                            <span class="parameter-name">🎤 Listening for medical parameters...</span>
                            <span class="parameter-value">--</span>
                        </div>
                    `;
                    return;
                }

                paramsList.innerHTML = '';

                for (let [name, value] of Object.entries(this.parameters)) {
                    const parameterItem = document.createElement('div');
                    parameterItem.className = 'parameter-item detected';
                    parameterItem.innerHTML = `
                        <span class="parameter-name">✅ ${name}</span>
                        <span class="parameter-value">${value}</span>
                    `;
                    paramsList.appendChild(parameterItem);
                }
            }

            updateDocumentPreview() {
                const preview = document.getElementById('documentPreview');

                if (!this.patientName || !this.examType) {
                    preview.textContent = `Professional medical report will generate automatically as you speak...

Try saying:
• "Patient Rajesh Kumar, 45-year-old male"
• "CT brain shows normal findings"
• "MRI cervical spine for Priya Sharma"`;
                    preview.classList.remove('active');
                    return;
                }

                const documentContent = this.generateMedicalReport();
                preview.textContent = documentContent;
                preview.classList.add('active');
                this.currentReport = documentContent;
            }

            generateMedicalReport() {
                const todayDate = new Date().toLocaleDateString('en-GB').replace(/\//g, '-');

                switch (this.examType) {
                    case 'CT Brain':
                        return this.generateCTBrainReport(todayDate);
                    case 'MRI Brain':
                        return this.generateMRIBrainReport(todayDate);
                    case 'MRI Stroke Protocol':
                        return this.generateMRIStrokeReport(todayDate);
                    case 'MRI Cervical Spine':
                        return this.generateMRISpineReport(todayDate);
                    case 'CT Abdomen':
                        return this.generateCTAbdomenReport(todayDate);
                    default:
                        return this.generateGeneralReport(todayDate);
                }
            }

            generateCTBrainReport(date) {
                const age = this.parameters['Age'] || '[Age]';
                const sex = this.detectedGender || 'M';
                const uhid = `UH${Math.floor(Math.random() * 900000) + 100000}`;

                return `**Name: ${this.patientName || '[Patient Name]'}                      Sex: ${sex}           Age: ${age} Yrs                    Date: ${date}**
**Reff.By: Dr. Rajesh Kumar                                                                     UHID: ${uhid}**
** **
**DEPARTMENT OF RADIO-DIAGNOSIS**
**CT BRAIN PLAIN**
** **
**TECHNIQUE: **CT scan of brain was performed on 96 slice MDCT scanner.
** **
**FINDINGS:**
 
${this.parameters['Cerebral Matter'] || 'The cerebral grey and white matter appear normal. No focal lesion is seen in the cerebral parenchyma.'}
 
${this.parameters['Basal Ganglia'] || 'The basal ganglia and thalami are normal.'}
 
${this.parameters['Posterior Fossa'] || 'The posterior fossa structures including the brain stem and cerebellum do not show any abnormality.'}
 
${this.parameters['Ventricular System'] || 'The ventricular system, cisternal & sulcal spaces are normal.'}
 
${this.parameters['Hemorrhage'] || 'No intra / extra-axial bleed seen.'}
 
${this.parameters['Midline Shift'] || 'No midline shift / herniations noted.'}
 
Skull bones are unremarkable.
 
**IMPRESSION**:
** **
·       **${this.parameters['Impression'] || 'No significant brain parenchymal abnormality detected.'}**
** **
*---Suggested clinical correlation/further evaluation if clinically indicated.*
** **
** **
**             CONSULTANT RADIOLOGIST**
**                                                                            DR. VISHRUTH RASA. M.D. RADIOLOGY**`;
            }

            generateMRIBrainReport(date) {
                const age = this.parameters['Age'] || '[Age]';
                const sex = this.detectedGender || 'M';
                const uhid = `UH${Math.floor(Math.random() * 900000) + 100000}`;

                return `**Name: ${this.patientName || '[Patient Name]'}               Sex: ${sex}                Age: ${age} Yrs      Date: ${date}**
**Reff.By: Dr. Rajesh Kumar                                                     UHID: ${uhid}**
** **
**DEPARTMENT OF RADIO-DIAGNOSIS**
**MRI BRAIN PLAIN (ANGIOGRAM)**
** **
**TECHNIQUE**:
T2 FSE Axials / Sagittals & Coronals.T1 &T2 FLAIR Axials. DWI, GRE Axials.
3D TOF MR Angiography of Intra + Extracranial Arteries.
 
**FINDINGS**:
 
${this.parameters['Diffusion Weighted'] || 'No restriction is seen on diffusion weighted images to suggest acute infarct.'}
 
${this.parameters['Hemorrhage'] || 'No intracerebral hemorrhage is noted.'}
 
${this.parameters['Basal Ganglia'] || 'Bilateral basal ganglia and thalami are normal.'}
 
${this.parameters['Posterior Fossa'] || 'Cerebellum and brainstem are unremarkable.'}
 
${this.parameters['Ventricular System'] || 'The ventricular system, cisternal & sulcal spaces are normal.'}
 
**MR ANGIOGRAPHY SHOWS:**
 
${this.parameters['MR Angiography'] || 'Bilateral intracranial internal carotid arteries, anterior & middle cerebral arteries and their branches are normal in caliber/flow signal.\n\nThe basilar artery and bilateral posterior cerebral arteries are normal in caliber and course.\n\nBoth vertebral arteries are normal in calibre and flow signal.'}

**IMPRESSION: **
** **
·       **${this.parameters['Impression'] || 'No significant brain parenchymal abnormality detected.'}**
** **
*                        ---Suggested clinical correlation / further evaluation if clinically indicated.*
** **
** **
** **
**CONSULTANT RADIOLOGIST**
**                                                                                                            DR. VISHRUTH RASA. M.D. RADIOLOGY**`;
            }

            generateMRIStrokeReport(date) {
                const age = this.parameters['Age'] || '[Age]';
                const sex = this.detectedGender || 'M';
                const uhid = `UH${Math.floor(Math.random() * 900000) + 100000}`;

                return `**Name: ${this.patientName || '[Patient Name]'}                       Sex: ${sex}                  Age: ${age} Yrs                             Date: ${date}**
**Reff.By: Dr. Emergency Medicine                                                                                             UHID: ${uhid}**
** **
**DEPARTMENT OF RADIO-DIAGNOSIS**
**MRI STROKE PROTOCOL**
** **
**TECHNIQUE**:
T2 FSE Axials / Sagittals & Coronals.T1 &T2 FLAIR Axials. DWI, GRE Axials.
3D TOF MR Angiography of Intra cranial Arteries.
 
**FINDINGS**:
 
${this.parameters['Diffusion Weighted'] || 'No restriction is seen on diffusion weighted images to suggest acute infarct.'}
 
${this.parameters['Hemorrhage'] || 'No intracerebral hemorrhage is noted.'}
 
${this.parameters['Basal Ganglia'] || 'Bilateral basal ganglia and thalami are normal.'}
 
${this.parameters['Posterior Fossa'] || 'Cerebellum and brainstem are unremarkable.'}
 
${this.parameters['Ventricular System'] || 'The ventricular system, cisternal & sulcal spaces are normal.'}
 
**MR ANGIOGRAPHY SHOWS:**
 
${this.parameters['MR Angiography'] || 'Bilateral intracranial internal carotid arteries, anterior & middle cerebral arteries and their branches are normal in caliber/flow signal.\n\nThe basilar artery and bilateral posterior cerebral arteries are normal in caliber and course.\n\nBoth vertebral arteries are normal in calibre and flow signal.'}

**IMPRESSION: **
** **
·       **${this.parameters['Impression'] || 'No significant brain parenchymal abnormality detected.'}**
** **
*                        ---Suggested clinical correlation / further evaluation if clinically indicated.*
** **
** **
** **
**CONSULTANT RADIOLOGIST**
**                                                                                                            DR. VISHRUTH RASA. M.D. RADIOLOGY**`;
            }

            generateMRISpineReport(date) {
                const age = this.parameters['Age'] || '[Age]';
                const sex = this.detectedGender || 'M';
                const uhid = `UH${Math.floor(Math.random() * 900000) + 100000}`;

                return `** **
**Name: ${this.patientName || '[Patient Name]'}                                   Sex: ${sex}                Age: ${age} Yrs                  Date: ${date}**
**Reff.By.Dr: Orthopedic Surgery                                                                                       UHID: ${uhid}**
**            **                   **DEPARTMENT OF RADIO-DIAGNOSIS**
**          MRI CERVICAL SPINE WITH WHOLE SPINE SCREENING**
** **
**TECHNIQUE:** T1-T2 sagittal & axials, IR coronals.
 
**FINDINGS:**
 
${this.parameters['Curvature'] || 'Curvature of spine is well maintained.'}
 
Canal diameters are as below:
Level     C2-C3   C3-C4   C4-C5   C5-C6   C6-C7
AP Mm        13      13     8.7      11     9.5
 
**WHOLE SPINE SCREENING:**
 
${this.parameters['Vertebral Bodies'] || 'Alignment, heights and bone marrow signal intensity of rest of the cervical vertebral bodies are within normal limits.'}
 
${this.parameters['Disc Configuration'] || 'Configuration of rest of the discs, thecal sac, filar roots, lateral recesses, neural foraminae, neural arches, facet joints and posterior elements are within normal limits.'}
 
**IMPRESSION:**
** **
·       **${this.parameters['Impression'] || 'No significant abnormality detected.'}**
** **
** **
** **
** **
** **
** **
** **
**CONSULTANT RADIOLOGIST**
**                                                                                                            DR. VISHRUTH RASA. M.D. RADIOLOGY**`;
            }

            generateCTAbdomenReport(date) {
                const age = this.parameters['Age'] || '[Age]';
                const sex = this.detectedGender || 'M';
                const uhid = `UH${Math.floor(Math.random() * 900000) + 100000}`;

                return `**Name: ${this.patientName || '[Patient Name]'}                       Sex: ${sex}                   Age: ${age} Yrs                   Date: ${date}**
**Reff.By.Dr: Internal Medicine                                                                                       UHID: ${uhid}**
** **
**DEPARTMENT OF RADIO-DIAGNOSIS**
**CT ABDOMEN AND PELVIS PLAIN**
** **
**TECHNIQUE:** CT abdomen plain study was performed on 96 slice MDCT scanner with detector collimation of 0.625mm, 1mm reconstruction in saggital and coronal planes.
** **
**FINDINGS:**
 
${this.parameters['Liver'] || 'Liver is normal in size (cm) & attenuation. No IHBRD.'}
 
CBD normal in caliber.
 
${this.parameters['Gallbladder'] || 'Gallbladder is well distended. Wall thickness appears normal. No e/o hyperdense calculi.'}
 
${this.parameters['Spleen'] || 'Spleen is normal in size (cm) and attenuation.'}
 
Mesentery and omentum are normal.
 
${this.parameters['Pancreas'] || 'Pancreas: Normal in size, shape and attenuation. No e/o ductal dilatation, parenchymal calcifications and peripancreatic fluid collection.'}
 
${this.parameters['Kidneys'] || 'Both kidneys are normal in size, shape and attenuation. No hydronephrosis / calculi.'}
 
Both adrenal glands appear normal.
 
Aorta and IVC are normal. 
 
Urinary bladder is normal in contours. No filling defects noted. No calculi. Wall thickness appears normal. 
 
Prostate is normal in size and attenuation.
 
No free fluid in the peritoneal cavity. 
 
**IMPRESSION: **
** **
·       **${this.parameters['Impression'] || 'No significant abnormality detected.'}**
** **
**            CONSULTANT RADIOLOGIST**
**                                                                            DR. VISHRUTH RASA. M.D. RADIOLOGY**`;
            }

            generateGeneralReport(date) {
                const age = this.parameters['Age'] || '[Age]';
                const sex = this.detectedGender || 'M';

                return `# Medical Examination Report

**Patient:** ${this.patientName || '[Patient Name]'}
**Date:** ${date}
**Age:** ${age} years
**Gender:** ${sex}

## Examination Type: ${this.examType}

## Findings:
${Object.entries(this.parameters).map(([key, value]) => `• ${key}: ${value}`).join('\n')}

## Complete Transcript:
${this.transcript}

*Generated automatically: ${date}*`;
            }

            showActionButtons() {
                if (this.patientName && this.examType) {
                    document.getElementById('downloadBtn').style.display = 'flex';
                    document.getElementById('copyBtn').style.display = 'flex';
                }
            }

            downloadReport() {
                if (!this.currentReport) {
                    this.showNotification('No report to download', 'warning');
                    return;
                }

                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `${this.patientName.replace(/\s+/g, '_')}_${this.examType.replace(/\s+/g, '_').toLowerCase()}_${timestamp}.doc`;

                this.downloadWordDocument(filename, this.currentReport);
            }

            downloadWordDocument(filename, content) {
                const wordHTML = this.generateWordHTML(content);

                const blob = new Blob([wordHTML], {
                    type: 'application/msword'
                });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                this.showNotification(`Word Document downloaded: ${filename}`, 'success');
            }

            generateWordHTML(content) {
                let htmlContent = content
                    .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                    .split('\n')
                    .map(line => {
                        if (line.trim() === '') {
                            return '<p>&nbsp;</p>';
                        }
                        return `<p>${line}</p>`;
                    })
                    .join('\n');

                return `
<!DOCTYPE html>
<html xmlns:o="urn:schemas-microsoft-com:office:office" 
      xmlns:w="urn:schemas-microsoft-com:office:word" 
      xmlns="http://www.w3.org/TR/REC-html40">
<head>
    <meta charset="utf-8">
    <meta name="ProgId" content="Word.Document">
    <meta name="Generator" content="Microsoft Word 15">
    <meta name="Originator" content="Microsoft Word 15">
    <title>Medical Report</title>
    <style>
        @page {
            size: A4;
            margin: 1in;
        }
        body {
            font-family: 'Times New Roman', serif;
            font-size: 12pt;
            line-height: 1.2;
            margin: 0;
            padding: 0;
        }
        p {
            margin: 0;
            padding: 0;
            margin-bottom: 6pt;
        }
        b, strong {
            font-weight: bold;
        }
    </style>
</head>
<body>
    ${htmlContent}
</body>
</html>`;
            }

            copyToClipboard() {
                if (!this.currentReport) {
                    this.showNotification('No report to copy', 'warning');
                    return;
                }

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(this.currentReport).then(() => {
                        this.showNotification('Report copied to clipboard!', 'success');
                    }).catch(() => {
                        this.fallbackCopyToClipboard();
                    });
                } else {
                    this.fallbackCopyToClipboard();
                }
            }

            fallbackCopyToClipboard() {
                const textArea = document.createElement('textarea');
                textArea.value = this.currentReport;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                try {
                    document.execCommand('copy');
                    this.showNotification('Report copied to clipboard!', 'success');
                } catch (err) {
                    this.showNotification('Could not copy text. Please copy manually from preview.', 'error');
                }

                document.body.removeChild(textArea);
            }

            clearAll() {
                this.transcript = '';
                this.patientName = '';
                this.examType = '';
                this.detectedGender = '';
                this.parameters = {};
                this.currentReport = '';

                // Reset UI
                document.getElementById('patientName').textContent = 'Listening...';
                document.getElementById('examType').textContent = 'Detecting...';
                document.getElementById('detectedGender').textContent = 'Auto-detect';
                document.getElementById('patientAge').textContent = '--';

                // Add detecting classes back
                document.getElementById('patientName').classList.add('detecting');
                document.getElementById('examType').classList.add('detecting');
                document.getElementById('detectedGender').classList.add('detecting');
                document.getElementById('patientAge').classList.add('detecting');

                document.getElementById('parametersList').innerHTML = `
                    <div class="parameter-item">
                        <span class="parameter-name">🎤 Ready for voice input...</span>
                        <span class="parameter-value">--</span>
                    </div>
                `;

                document.getElementById('documentPreview').textContent = `Professional medical report will generate automatically as you speak...

Try saying:
• "Patient Rajesh Kumar, 45-year-old male"
• "CT brain shows normal findings"
• "MRI cervical spine for Priya Sharma"`;

                document.getElementById('documentPreview').classList.remove('active');

                document.getElementById('transcriptText').textContent = 'Your voice will be transcribed here in real-time...';

                // Hide action buttons
                document.getElementById('downloadBtn').style.display = 'none';
                document.getElementById('copyBtn').style.display = 'none';

                this.showNotification('All data cleared', 'success');
            }

            updateRecordingUI(recording) {
                const micButton = document.getElementById('micButton');
                const micIcon = document.getElementById('micIcon');
                const recordingIndicator = document.getElementById('recordingIndicator');

                if (recording) {
                    micButton.classList.add('recording');
                    micIcon.className = 'fas fa-stop';
                    recordingIndicator.style.display = 'block';
                } else {
                    micButton.classList.remove('recording');
                    micIcon.className = 'fas fa-microphone';
                    recordingIndicator.style.display = 'none';
                }
            }

            updateSystemStatus(status, text) {
                const statusIndicator = document.getElementById('systemStatus');
                statusIndicator.className = `status-indicator ${status}`;

                const icons = {
                    ready: 'fas fa-check-circle',
                    recording: 'fas fa-circle',
                    error: 'fas fa-exclamation-triangle'
                };

                statusIndicator.innerHTML = `
                    <i class="${icons[status] || 'fas fa-info-circle'}"></i>
                    <span>${text}</span>
                `;
            }

            updateMicStatus(status) {
                document.getElementById('micStatus').textContent = status;
            }

            updateTranscript() {
                const transcriptText = document.getElementById('transcriptText');
                transcriptText.textContent = this.transcript || 'Your voice will be transcribed here in real-time...';
                transcriptText.scrollTop = transcriptText.scrollHeight;
            }

            showInterimTranscript(interim) {
                const transcriptText = document.getElementById('transcriptText');
                transcriptText.innerHTML = `${this.transcript}<span style="color: #999; font-style: italic;">${interim}</span>`;
                transcriptText.scrollTop = transcriptText.scrollHeight;
            }

            adjustMobileLayout() {
                if (window.innerHeight < window.innerWidth) {
                    // Landscape mode
                    document.body.style.height = '100vh';
                } else {
                    // Portrait mode
                    document.body.style.height = 'auto';
                }
            }

            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    ${message}
                `;

                document.body.appendChild(notification);

                // Trigger animation
                setTimeout(() => {
                    notification.classList.add('show');
                }, 100);

                // Remove notification
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 4000);
            }

            simulateDemo() {
                this.isRecording = true;
                this.updateRecordingUI(true);
                this.updateSystemStatus('recording', 'Demo Mode Active');
                this.updateMicStatus('🎤 Demo Mode - Simulating medical voice input...');

                const demoScenarios = [
                    [
                        "Patient Rajesh Kumar is here for CT brain examination",
                        "This is a 45-year-old male patient",
                        "The cerebral grey and white matter appear normal",
                        "No focal lesion seen in cerebral parenchyma",
                        "Basal ganglia and thalami are normal",
                        "Posterior fossa structures are unremarkable",
                        "Ventricular system and cisternal spaces are normal",
                        "No intra or extra-axial bleed seen",
                        "No midline shift noted",
                        "Impression: No significant brain abnormality detected"
                    ],
                    [
                        "MRI cervical spine for Priya Sharma",
                        "32-year-old female patient",
                        "Curvature of spine is well maintained",
                        "Canal diameters are within normal limits",
                        "Vertebral bodies show normal alignment",
                        "Disc configuration appears normal",
                        "No significant spinal abnormality"
                    ]
                ];

                const selectedScenario = demoScenarios[Math.floor(Math.random() * demoScenarios.length)];

                let index = 0;
                const interval = setInterval(() => {
                    if (index < selectedScenario.length && this.isRecording) {
                        const text = selectedScenario[index];
                        this.transcript += text + ' ';
                        this.processTranscript(text);
                        this.updateTranscript();
                        this.updateDisplay();
                        index++;
                    } else {
                        clearInterval(interval);
                        if (this.isRecording) {
                            this.updateMicStatus('✅ Demo complete - Professional medical report generated!');
                            this.updateSystemStatus('ready', 'Demo Complete');
                        }
                    }
                }, 2000);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            new MedVoiceAI();
        });
    </script>
</body>
</html>